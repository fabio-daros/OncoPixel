{% extends "shared/base.html" %}
{% load i18n static %}

{% block title %}{% if patient %}{% trans "Edit Patient" %}{% else %}{% trans "Register Patient" %}{% endif %} - OncoPixel{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}"/>

<div class="max-w-7xl mx-auto">
  <!-- Título + ações -->
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl md:text-4xl font-semibold text-white">
        {% if patient %}{% trans "Edit Patient" %}{% else %}{% trans "Register Patient" %}{% endif %}
      </h1>
      <p class="text-gray-400 mt-1">
        {% if patient %}
          {% trans "Edit patient data here." %}
        {% else %}
          {% trans "Register patient data here." %}
        {% endif %}
      </p>
    </div>

    <div class="flex gap-2">
    </div>
  </header>

  {% if messages %}
    <ul class="mb-4 space-y-2">
      {% for message in messages %}
        <li class="rounded-xl border border-gray-700 px-3 py-2 {% if message.tags == 'success' %}bg-emerald-900/30 text-emerald-200{% elif message.tags == 'error' %}bg-red-900/30 text-red-200{% else %}bg-gray-900 text-gray-200{% endif %}">
          {{ message }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if form and form.errors %}
    <div class="mb-6 rounded-xl border border-red-800 bg-red-900/20 p-4 text-red-200">
      <p class="font-medium mb-2">{% trans "Please correct the errors below." %}</p>
      <ul class="list-disc pl-5">
        {% for field, errors in form.errors.items %}
          <li><span class="text-gray-300">{{ field }}</span>: {{ errors|join:", " }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- FORM principal -->
  <form id="patients" method="post"
        action="{% if patient %}{% url 'patients:update' patient.id %}{% else %}{% url 'patients:create' %}{% endif %}"
        class="space-y-8">
    {% csrf_token %}

    <section class="grid lg:grid-cols-2 gap-8">
      <!-- Coluna 1 -->
      <div class="space-y-6">
        <h2 class="text-gray-300 font-semibold">{% trans "Personal data" %}</h2>

        <div class="space-y-4">
          <div>
            <label for="name" class="block text-gray-300 mb-1">{% trans "Name" %}</label>
            <input type="text" name="name" id="name" required
                   value="{{ form.name.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring"/>
          </div>

          <div>
            <label for="surname" class="block text-gray-300 mb-1">{% trans "Surname" %}</label>
            <input type="text" name="surname" id="surname" required
                   value="{{ form.surname.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>

          <div class="grid grid-cols-3 gap-4">
            <div class="col-span-2">
              <label for="birth" class="block text-gray-300 mb-1">{% trans "Birth Date" %}</label>
              <input type="date" name="birth" id="birth" required
                     value="{{ form.birth.value|date:'Y-m-d' }}"
                     onchange="calculateAge(this.value)"
                     class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
            </div>
            <div>
              <label for="age" class="block text-gray-300 mb-1">{% trans "Age" %}</label>
              <input type="number" name="age" id="age" readonly
                     title="{% trans 'This field is calculated from the birth date.' %}"
                     value="{{ form.age.value }}"
                     class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-400 px-3 py-2"/>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="weight" class="block text-gray-300 mb-1">{% trans "Weight" %}</label>
              <div class="flex gap-2">
                <input type="number" step="0.01" min="0" name="weight" id="weight" required
                       value="{{ form.weight.value }}"
                       class="flex-1 rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
                <select id="weight_unit" name="weight_unit"
                        class="w-28 rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2">
                  <option value="kg" {% if form.weight_unit.value == "kg" %}selected{% endif %}>kg</option>
                  <option value="lb" {% if form.weight_unit.value == "lb" %}selected{% endif %}>lb</option>
                </select>
              </div>
            </div>

            <div>
              <label for="sex" class="block text-gray-300 mb-1">{% trans "Sex" %}</label>
              <select name="sex" id="sex" required
                      class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2">
                <option value="">{% trans "Select..." %}</option>
                <option value="male" {% if form.sex.value == "male" %}selected{% endif %}>{% trans "Male" %}</option>
                <option value="female" {% if form.sex.value == "female" %}selected{% endif %}>{% trans "Female" %}</option>
                <option value="other" {% if form.sex.value == "other" %}selected{% endif %}>{% trans "Other" %}</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="ethnicity" class="block text-gray-300 mb-1">{% trans "Race" %}</label>
              <input type="text" name="ethnicity" id="ethnicity" required
                     value="{{ form.ethnicity.value }}"
                     class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
            </div>
            <div>
              <label for="pregnant" class="block text-gray-300 mb-1">{% trans "Pregnant" %}</label>
              <select name="pregnant" id="pregnant" required
                      class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2">
                <option value="">{% trans "Select..." %}</option>
                <option value="unknown" {% if form.pregnant.value == "unknown" %}selected{% endif %}>{% trans "Unknown" %}</option>
                <option value="yes" {% if form.pregnant.value == "yes" %}selected{% endif %}>{% trans "Yes" %}</option>
                <option value="no" {% if form.pregnant.value == "no" %}selected{% endif %}>{% trans "No" %}</option>
              </select>
            </div>
          </div>
        </div>

        <h2 class="text-gray-300 font-semibold">{% trans "Contact detail" %}</h2>
        <div class="grid grid-cols-5 gap-4">
          <div class="col-span-3">
            <label for="email" class="block text-gray-300 mb-1">Email</label>
            <div class="flex">
              <span class="inline-flex items-center rounded-l-xl border border-gray-700 bg-gray-800 px-3 text-gray-300">@</span>
              <input type="email" name="email" id="email" required
                     value="{{ form.email.value }}"
                     class="w-full rounded-r-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
            </div>
          </div>
          <div class="col-span-2">
            <label for="phone" class="block text-gray-300 mb-1">{% trans "Phone/Cel" %}</label>
            <input type="tel" name="phone" id="phone" required
                   value="{{ form.phone.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
        </div>

        <div>
          <label for="notes" class="block text-gray-300 mb-1">{% trans "Notes" %}</label>
          <textarea name="notes" id="notes" rows="3"
                    class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2">{{ form.notes.value }}</textarea>
        </div>
      </div>

      <!-- Coluna 2 -->
      <div class="space-y-6">
        <h2 class="text-gray-300 font-semibold">{% trans "Address" %}</h2>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="country" class="block text-gray-300 mb-1">{% trans "Country" %}</label>
            <input type="text" name="country" id="country" required
                   value="{{ form.country.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
          <div>
            <label for="state" class="block text-gray-300 mb-1">{% trans "State" %}</label>
            <input type="text" name="state" id="state" required
                   value="{{ form.state.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
          <div>
            <label for="county" class="block text-gray-300 mb-1">{% trans "County" %}</label>
            <input type="text" name="county" id="county" required
                   value="{{ form.county.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
          <div></div>
        </div>

        <div>
          <label for="address" class="block text-gray-300 mb-1">{% trans "Address" %}</label>
          <input type="text" name="address" id="address" required
                 value="{{ form.address.value }}"
                 class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div>
            <label for="zipcode" class="block text-gray-300 mb-1">{% trans "Zip Code" %}</label>
            <input type="text" name="zipcode" id="zipcode" required
                   value="{{ form.zipcode.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
          <div>
            <label for="number" class="block text-gray-300 mb-1">{% trans "Number" %}</label>
            <input type="text" name="number" id="number" required
                   value="{{ form.number.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
        </div>

        <h2 class="text-gray-300 font-semibold">{% trans "Additional data" %}</h2>

        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label for="mother_name" class="block text-gray-300 mb-1">{% trans "Mother Name" %}</label>
            <input type="text" name="mother_name" id="mother_name" required
                   value="{{ form.mother_name.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
          <div>
            <label for="document" class="block text-gray-300 mb-1">CPF</label>
            <input type="text" name="document" id="document" required maxlength="11" pattern="\d{11}"
                   value="{{ form.document.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
          <div>
            <label for="cns" class="block text-gray-300 mb-1">CNS</label>
            <input type="text" name="cns" id="cns" required maxlength="15" pattern="\d{15}"
                   value="{{ form.cns.value }}"
                   class="w-full rounded-xl border border-gray-700 bg-gray-900 text-gray-100 px-3 py-2"/>
          </div>
        </div>
      </div>
    </section>

    <!-- Ações -->
    <div class="flex items-center justify-center gap-3 py-4">
        <!-- Botão: localizar pacientes (abre modal) -->
      <button type="button"
              class="rounded-2xl border border-gray-700 bg-gray-900 px-4 py-2 text-gray-200 hover:bg-green-700"
              data-modal-target="patientModal">
        <span class="inline-flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z"/></svg>
          {% trans "Locate patients" %}
        </span>
      </button>
      <button type="button"
              class="rounded-2xl border border-gray-700 bg-gray-900 px-5 py-2 text-gray-200 hover:bg-green-700"
              onclick="clearForm()">
        {% trans "Clear" %}
      </button>
      <button type="submit"
              class="rounded-2xl bg-green-600 px-6 py-2 font-medium text-white hover:bg-green-700">
        {% if patient %}{% trans "Edit" %}{% else %}{% trans "Save" %}{% endif %}
      </button>
    </div>
  </form>

  <!-- Lista compacta (se enviada pela view) -->
  {% if patients %}
    <div class="mt-10">
      <h3 class="text-gray-300 font-semibold mb-3">{% trans "Recent patients" %}</h3>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for p in patients %}
          <a href="{% url 'patients:detail' p.id %}"
             class="block rounded-2xl border border-gray-800 p-4 hover:bg-gray-900/50">
            <div class="text-sm text-gray-400">{{ p.cns }}</div>
            <div class="text-white font-medium">{{ p.surname }}, {{ p.name }}</div>
            <div class="text-gray-400 text-sm">{{ p.birth|date:"Y-m-d" }} · {{ p.sex|title }}</div>
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

{% include "patients/patient_search_modal.html" %}
{% include "patients/patient_detail_modal.html" %}

<!-- Scripts locais -->
<script>
  function calculateAge(isoDate) {
    if (!isoDate) return;
    const d = new Date(isoDate);
    const t = new Date();
    let age = t.getFullYear() - d.getFullYear();
    const m = t.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && t.getDate() < d.getDate())) age--;
    const input = document.getElementById('age');
    if (input) input.value = age >= 0 ? age : '';
  }

  function clearForm() {
    const form = document.getElementById('patients');
    if (!form) return;
    form.reset();
    const age = document.getElementById('age');
    if (age) age.value = '';
  }

  // Modal simples (abre/fecha)
  document.addEventListener('click', (e) => {
    const openBtn = e.target.closest('[data-modal-target="patientModal"]');
    const modal = document.getElementById('patientModal');
    if (openBtn && modal) { modal.classList.remove('hidden'); }
    if (e.target.closest('[data-modal-close]')) { modal.classList.add('hidden'); }
  });
</script>
{% endblock %}
